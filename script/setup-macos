#!/bin/bash

# macOS-specific setup script
# Usage: Called by setup script, do not run directly
# Installs Homebrew and packages from Brewfile

set -euo pipefail

# Get script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

echo "üçé macOS Package Installation"
echo "=============================="

_install_homebrew() {
    if ! command -v brew &>/dev/null; then
        echo "Installing Homebrew..."
        if /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"; then
            echo "‚úÖ Homebrew installed successfully"
            
            if [[ $(uname -m) == "arm64" ]]; then
                # let subsequent steps find brew
                export PATH="/opt/homebrew/bin:$PATH"
            fi
        else
            echo "‚ùå Failed to install Homebrew"
            exit 1
        fi
    else
        echo "‚úÖ Homebrew already installed"
    fi
}

_install_brew_packages() {
    echo "Setting up Homebrew packages..."
    
    _install_homebrew

    echo "Updating Homebrew..."
    brew update
    brew upgrade
    
    echo "Installing packages from Brewfile..."
    # Look for Brewfile in the same directory as this script
    
    if [ -f "$SCRIPT_DIR/Brewfile" ]; then
        echo "Using Brewfile from script directory..."
        brew bundle --file="$SCRIPT_DIR/Brewfile"
    else
        echo "‚ùå Error: Brewfile not found at $SCRIPT_DIR/Brewfile"
        echo "Please create a Brewfile in the script directory."
        return 1
    fi

    brew cleanup
    
    echo "‚úÖ Homebrew packages installation completed!"
}

main() {
    _install_brew_packages
    echo "‚úÖ macOS packages installed!"
}

main "$@"
