#!/bin/bash

# Bootstrap script for new machines
# Usage: curl -fsSL <raw-url>/bootstrap | bash
# Clones dotfiles repo and runs setup

set -euo pipefail

# dotfiles function (replaces alias)
dotfiles() {
    git --git-dir="$HOME/.dotfiles/" --work-tree="$HOME" "$@"
}

# Install git if needed
_install_git() {
    # Check if git is already available
    if command -v git &>/dev/null; then
        echo "‚úÖ Git already installed"
        return 0
    fi
    
    # macOS: install Xcode Command Line Tools (includes git)
    if [[ "$OSTYPE" == "darwin"* ]]; then
        echo "Installing Xcode Command Line Tools (includes Git)..."
        xcode-select --install 2>/dev/null || true
        echo "‚è≥ Please complete the Xcode CLT installation dialog, then press Enter..."
        read -r < /dev/tty
        if command -v git &>/dev/null; then
            echo "‚úÖ Git installed via Xcode CLT"
            return 0
        else
            echo "‚ùå Git still not found. Please install Xcode CLT manually and try again."
            exit 1
        fi
    fi
    
    # Linux: install git using apt
    if command -v apt-get &>/dev/null; then
        echo "Installing Git..."
        sudo apt-get update
        sudo apt-get install -y git
        echo "‚úÖ Git installed"
        return 0
    fi
    
    # Error: no git and no supported package manager
    echo "‚ùå Git not found and package manager not supported for automatic installation"
    echo "Please install git manually and try again"
    exit 1
}

_clone_dotfiles() {
    local dotfiles_dir="$HOME/.dotfiles"
    
    if [ ! -d "$dotfiles_dir" ]; then
        echo "Cloning dotfiles repository..."
        if git clone --bare https://github.com/hsin19/dotfiles.git "$dotfiles_dir"; then
            echo "‚úÖ Dotfiles repository cloned successfully"
        else
            echo "‚ùå Failed to clone dotfiles repository"
            exit 1
        fi
    else
        echo "‚úÖ Dotfiles repository already exists"
    fi

    dotfiles config --local status.showUntrackedFiles no
}

_handle_conflicts() {
    local operation="$1"
    local output="$2"
    local backup_dir="$HOME/config-backup"
    
    local operation_backup_dir
    operation_backup_dir="$backup_dir/$operation-conflicts-$(date +%Y%m%d_%H%M%S)"
    mkdir -p "$operation_backup_dir"

    local found=0
    while IFS= read -r raw; do
        line="${raw#"${raw%%[![:space:]]*}"}"
        line="${line%"${line##*[![:space:]]}"}"

        [ -z "$line" ] && continue

        case "$line" in
            error:*|fatal:*|warning:*|hint:*|Please*|Aborting*|From*|Updating*|"* branch "*|"* -> "*)
                continue
                ;;
        esac

        line="${line#./}"

        src=""
        if [ -e "$HOME/$line" ] || [ -L "$HOME/$line" ]; then
            src="$HOME/$line"
        else
            continue
        fi

        found=1
        dst="$operation_backup_dir/$line"
        mkdir -p "$(dirname "$dst")"
        mv -- "$src" "$dst"
        echo "‚ÑπÔ∏è  Backed up: $line"
    done <<< "$output"

    if [ "$found" -eq 1 ]; then
        return 0
    else
        echo "‚ö†Ô∏è No conflicts found"
        return 1
    fi
}

_checkout_dotfiles() {
    echo "Attempting dotfiles checkout..."
    
    if ! checkout_output=$(dotfiles checkout 2>&1); then
        if _handle_conflicts "checkout" "$checkout_output"; then
            if dotfiles checkout; then
                echo "‚úÖ Dotfiles checked out successfully (conflicts backed up)"
            else
                echo "‚ùå Dotfiles checkout failed"
                exit 1
            fi
        fi
    else
        echo "‚úÖ Dotfiles checked out successfully"
    fi
    
    # Pull latest changes
    echo "Pulling latest dotfiles updates..."
    if ! pull_output=$(dotfiles pull 2>&1); then
        # Check if it's a merge conflict
        if echo "$pull_output" | grep -q "would be overwritten\|Merge conflict"; then
            if _handle_conflicts "pull" "$pull_output"; then
                # Reset and pull again
                dotfiles reset --hard HEAD
                if dotfiles pull; then
                    echo "‚úÖ Dotfiles updated to latest version (conflicts backed up)"
                else
                    echo "‚ö†Ô∏è Still failed to pull updates after reset"
                fi
            fi
        else
            echo "‚ö†Ô∏è Failed to pull latest updates: $pull_output"
        fi
    else
        echo "‚úÖ Dotfiles updated to latest version"
    fi
}

main() {
    echo "üöÄ Starting dotfiles bootstrap..."
    
    _install_git
    _clone_dotfiles
    _checkout_dotfiles

    echo "‚úÖ Dotfiles bootstrap completed successfully!"
    
    # Check for -y or --yes argument
    local run_setup=false
    for arg in "$@"; do
        if [[ "$arg" == "-y" || "$arg" == "--yes" ]]; then
            run_setup=true
            break
        fi
    done

    # If setup not requested, ask the user
    if [ "$run_setup" = false ]; then
        echo ""
        read -p "Do you want to run the full setup script now? (y/N) " -n 1 -r < /dev/tty
        echo ""
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            run_setup=true
        fi
    fi

    if [ "$run_setup" = true ]; then
        echo "Running setup script..."
        if [ -f "$HOME/script/setup" ]; then
            bash "$HOME/script/setup"
        else
            echo "‚ùå Setup script not found at $HOME/script/setup"
        fi
    fi
}

main "$@"
