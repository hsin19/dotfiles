#!/bin/bash

# Personal git hooks installer
# Usage: ./setup-git-hook [path] or git setup-hook [path]
# Args: repo path (optional, defaults to current dir)

set -euo pipefail

# Function to setup prepare-commit-msg hook in a specific repository
setup_prepare_commit_msg_hook() {
    local repo_path="${1:-.}"
    local hook_file="$repo_path/.git/hooks/prepare-commit-msg"
    
    # Convert to absolute path
    repo_path=$(cd "$repo_path" && pwd)
    
    # Check if it's a git repository
    if [ ! -d "$repo_path/.git" ]; then
        echo "❌ Error: $repo_path is not a git repository"
        exit 1
    fi
    
    # Create hooks directory if it doesn't exist
    mkdir -p "$repo_path/.git/hooks"
    
    # The hook content
    local hook_content='#!/bin/bash

# Auto-generated by dotfiles setup
# Call external prepare-commit-msg script if it exists
EXTERNAL_SCRIPT="$HOME/script/prepare-commit-msg"

if [ -f "$EXTERNAL_SCRIPT" ] && [ -x "$EXTERNAL_SCRIPT" ]; then
    "$EXTERNAL_SCRIPT" "$@"
fi'
    
    if [ -f "$hook_file" ]; then
        # Check if our hook is already present
        if grep -q "dotfiles setup" "$hook_file"; then
            echo "✅ prepare-commit-msg hook already configured in $(basename "$repo_path")"
            return 0
        fi
        
        # Backup existing hook
        cp "$hook_file" "$hook_file.backup.$(date +%Y%m%d_%H%M%S)"
        echo "📦 Backed up existing prepare-commit-msg hook in $(basename "$repo_path")"
        
        # Append our hook to existing content
        echo "" >> "$hook_file"
        echo "$hook_content" >> "$hook_file"
    else
        # Create new hook file
        echo "$hook_content" > "$hook_file"
    fi
    
    # Make it executable
    chmod +x "$hook_file"
    echo "✅ prepare-commit-msg hook configured in $(basename "$repo_path")"
}

# Main
repo_path="${1:-.}"
echo "🔧 Setting up Git prepare-commit-msg hook in: $repo_path"
setup_prepare_commit_msg_hook "$repo_path"
echo "🎉 Prepare-commit-msg hook setup completed!"
echo ""
echo "💡 The hook will call ~/script/prepare-commit-msg if it exists"
echo "💡 Jira tickets will be automatically added to commit messages"
