#!/bin/bash

# Development environment setup script
# Usage: ./setup
# Sets up Homebrew, Git, Zsh, OpenCommit configs

set -euo pipefail

# Get script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Source library modules
source "$SCRIPT_DIR/lib/env-loader.sh"

_install_homebrew() {
    if ! command -v brew &>/dev/null; then
        echo "Installing Homebrew..."
        if /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"; then
            echo "✅ Homebrew installed successfully"
            
            if [[ $(uname -m) == "arm64" ]]; then
                # let subsequent steps find brew
                export PATH="/opt/homebrew/bin:$PATH"
            fi
        else
            echo "❌ Failed to install Homebrew"
            exit 1
        fi
    else
        echo "✅ Homebrew already installed"
    fi
}

_install_brew_packages() {
    echo "Setting up Homebrew packages..."
    
    _install_homebrew

    echo "Updating Homebrew..."
    brew update
    brew upgrade
    
    echo "Installing packages from Brewfile..."
    # Look for Brewfile in the same directory as this script
    
    if [ -f "$SCRIPT_DIR/Brewfile" ]; then
        echo "Using Brewfile from script directory..."
        brew bundle --file="$SCRIPT_DIR/Brewfile"
    else
        echo "❌ Error: Brewfile not found at $SCRIPT_DIR/Brewfile"
        echo "Please create a Brewfile in the script directory."
        return 1
    fi

    brew cleanup
    
    echo "✅ Homebrew packages installation completed!"
}

_setup_git_identities() {
    echo "Setting up Git identities..."
    
    # --- Global Git Config ---
    git config --global user.name "${GIT_USER_NAME:-Eric Yeh}"
    git config --global user.email "${GIT_USER_EMAIL:-eric91343@gmail.com}"

    # --- Git Aliases ---
    echo "Setting up Git aliases..."
    git config --global alias.ai-commit "!bash $HOME/script/ai-commit"
    git config --global alias.ccc "!bash $HOME/script/ai-commit"
    git config --global alias.setup-hook "!bash $HOME/script/setup-git-hook"
    git config --global alias.sss "!bash $HOME/script/setup-git-hook"
    echo "✅ Git aliases setup completed!"

    # --- Global Git Ignore ---
    echo "Setting up global Git ignore..."
    local global_gitignore="$HOME/.gitignore_global"
    git config --global core.excludesfile "$global_gitignore"
    echo "✅ Configured global gitignore to use $global_gitignore"

    # --- Per-directory Git Config ---
    mkdir -p "$HOME/repos/github"

    # onelab
    mkdir -p "$HOME/repos/onelab"
    git config --global includeIf."gitdir:~/repos/onelab/".path ~/repos/onelab/.gitconfig
    cat <<-EOF > ~/repos/onelab/.gitconfig
[user]
    email = ${ONELAB_EMAIL:-eric.yeh@onelab.tw}
EOF
    
    # Only create NuGet.config if ONELAB_NUGET_URL is set
    if [ -n "${ONELAB_NUGET_URL:-}" ]; then
        cat <<-EOF > ~/repos/onelab/NuGet.config
<?xml version="1.0" encoding="utf-8"?>
<configuration>
    <packageSources>
        <add key="onelab" value="$ONELAB_NUGET_URL" protocolVersion="3" />
    </packageSources>
</configuration>
EOF
    else
        echo "⚠️ ONELAB_NUGET_URL not set, skipping NuGet.config creation"
    fi

    # ascentistech
    mkdir -p "$HOME/repos/ascentistech"
    git config --global includeIf."gitdir:~/repos/ascentistech/".path ~/repos/ascentistech/.gitconfig
    cat <<-EOF > ~/repos/ascentistech/.gitconfig
[user]
    email = ${ASCENTISTECH_EMAIL:-eric.yeh@ascentistech.com}
EOF
    
    echo "✅ Git identities setup completed!"
}

_setup_zsh() {
    echo "Setting up Oh My Zsh and plugins..."

    # Check if Zsh is installed, which is a prerequisite for Oh My Zsh
    if ! command -v zsh &>/dev/null; then
        echo "⚠️ Zsh is not installed. Please install it first (e.g., via Homebrew)."
        return 1
    fi

    # Install Oh My Zsh if it's not already installed
    if [ ! -d "$HOME/.oh-my-zsh" ]; then
        echo "Installing Oh My Zsh..."
        # Run the installer non-interactively
        sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
    else
        echo "✅ Oh My Zsh is already installed."
    fi

    # Define the custom path for plugins and themes
    ZSH_CUSTOM="${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}"

    # Helper function to clone a git repo if the destination directory doesn't exist
    _clone_if_not_exists() {
        local repo_url="$1"
        local dest_path="$2"
        local name="$3"
        if [ ! -d "$dest_path" ]; then
            echo "Installing $name..."
            git clone --depth=1 "$repo_url" "$dest_path"
        else
            echo "✅ $name is already installed."
        fi
    }

    # Install theme and plugins
    _clone_if_not_exists "https://github.com/romkatv/powerlevel10k.git" "${ZSH_CUSTOM}/themes/powerlevel10k" "Powerlevel10k theme"
    _clone_if_not_exists "https://github.com/zsh-users/zsh-syntax-highlighting.git" "${ZSH_CUSTOM}/plugins/zsh-syntax-highlighting" "zsh-syntax-highlighting plugin"
    _clone_if_not_exists "https://github.com/zsh-users/zsh-autosuggestions.git" "${ZSH_CUSTOM}/plugins/zsh-autosuggestions" "zsh-autosuggestions plugin"
    _clone_if_not_exists "https://github.com/TamCore/autoupdate-oh-my-zsh-plugins.git" "${ZSH_CUSTOM}/plugins/autoupdate" "autoupdate-oh-my-zsh-plugins"

    echo "✅ Oh My Zsh and plugins installed."
}

_setup_npm_packages() {
    echo "Setting up npm packages..."

    if ! command -v npm &> /dev/null; then
        echo "❌ npm not found, please install Node.js first."
        return 1
    fi

    # Define global npm packages to install/update
    local npm_packages=(
        "@anthropic-ai/claude-code"
        "@google/gemini-cli"
        "@github/copilot"
    )
    
    echo "Installing/updating global npm packages..."
    
    npm update -g npm
    
    for package in "${npm_packages[@]}"; do
        echo "Installing/updating $package..."
        npm install -g "$package@latest"
    done
    
    echo "✅ npm packages setup completed!"
}

main() {
    echo "Starting development environment setup..."

    load_env "$SCRIPT_DIR"
    _install_brew_packages
    _setup_zsh
    _setup_git_identities
    _setup_npm_packages

    echo "All done! Your development environment is ready."
}

main "$@"