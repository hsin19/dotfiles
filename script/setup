#!/bin/bash

# Development environment setup script (Unified Entry Point)
# Usage: ./setup
# Detects OS and runs appropriate platform-specific setup, then common configurations

set -euo pipefail

# Get script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Source library modules
source "$SCRIPT_DIR/lib/env-loader.sh"
source "$SCRIPT_DIR/lib/os-detect.sh"

echo "üöÄ Development Environment Setup"
echo "=================================="

# ============================================================================
# Shared Setup Functions (Cross-platform)
# ============================================================================

_setup_git_identities() {
    echo "Setting up Git identities..."
    
    # --- Global Git Config ---
    git config --global user.name "${GIT_USER_NAME:-Eric Yeh}"
    git config --global user.email "${GIT_USER_EMAIL:-eric91343@gmail.com}"

    # --- Git Aliases ---
    echo "Setting up Git aliases..."
    git config --global alias.ai-commit "!bash $HOME/script/ai-commit"
    git config --global alias.ccc "!bash $HOME/script/ai-commit"
    git config --global alias.setup-hook "!bash $HOME/script/setup-git-hook"
    git config --global alias.sss "!bash $HOME/script/setup-git-hook"
    echo "‚úÖ Git aliases setup completed!"

    # --- Global Git Ignore ---
    echo "Setting up global Git ignore..."
    local global_gitignore="$HOME/.gitignore_global"
    git config --global core.excludesfile "$global_gitignore"
    echo "‚úÖ Configured global gitignore to use $global_gitignore"

    # --- Per-directory Git Config ---
    mkdir -p "$HOME/repos/github"

    # onelab
    mkdir -p "$HOME/repos/onelab"
    git config --global includeIf."gitdir:~/repos/onelab/".path ~/repos/onelab/.gitconfig
    cat <<-EOF > ~/repos/onelab/.gitconfig
[user]
    email = ${ONELAB_EMAIL:-eric.yeh@onelab.tw}
EOF
    
    # Only create NuGet.config if ONELAB_NUGET_URL is set
    if [ -n "${ONELAB_NUGET_URL:-}" ]; then
        cat <<-EOF > ~/repos/onelab/NuGet.config
<?xml version="1.0" encoding="utf-8"?>
<configuration>
    <packageSources>
        <add key="onelab" value="$ONELAB_NUGET_URL" protocolVersion="3" />
    </packageSources>
</configuration>
EOF
    else
        echo "‚ö†Ô∏è  ONELAB_NUGET_URL not set, skipping NuGet.config creation"
    fi

    # ascentistech
    mkdir -p "$HOME/repos/ascentistech"
    git config --global includeIf."gitdir:~/repos/ascentistech/".path ~/repos/ascentistech/.gitconfig
    cat <<-EOF > ~/repos/ascentistech/.gitconfig
[user]
    email = ${ASCENTISTECH_EMAIL:-eric.yeh@ascentistech.com}
EOF
    
    echo "‚úÖ Git identities setup completed!"
}

_setup_zsh() {
    echo "Setting up Oh My Zsh and plugins..."

    # Check if Zsh is installed
    if ! command -v zsh &>/dev/null; then
        echo "‚ö†Ô∏è  Zsh is not installed. It should have been installed by the platform setup."
        return 1
    fi

    # Install Oh My Zsh if it's not already installed
    if [ ! -d "$HOME/.oh-my-zsh" ]; then
        echo "Installing Oh My Zsh..."
        sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
    else
        echo "‚úÖ Oh My Zsh is already installed."
    fi

    # Define the custom path for plugins and themes
    ZSH_CUSTOM="${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}"

    # Helper function to clone a git repo if the destination directory doesn't exist
    _clone_if_not_exists() {
        local repo_url="$1"
        local dest_path="$2"
        local name="$3"
        if [ ! -d "$dest_path" ]; then
            echo "Installing $name..."
            git clone --depth=1 "$repo_url" "$dest_path"
        else
            echo "‚úÖ $name is already installed."
        fi
    }

    # Install theme and plugins
    _clone_if_not_exists "https://github.com/romkatv/powerlevel10k.git" "${ZSH_CUSTOM}/themes/powerlevel10k" "Powerlevel10k theme"
    _clone_if_not_exists "https://github.com/zsh-users/zsh-syntax-highlighting.git" "${ZSH_CUSTOM}/plugins/zsh-syntax-highlighting" "zsh-syntax-highlighting plugin"
    _clone_if_not_exists "https://github.com/zsh-users/zsh-autosuggestions.git" "${ZSH_CUSTOM}/plugins/zsh-autosuggestions" "zsh-autosuggestions plugin"
    _clone_if_not_exists "https://github.com/TamCore/autoupdate-oh-my-zsh-plugins.git" "${ZSH_CUSTOM}/plugins/autoupdate" "autoupdate-oh-my-zsh-plugins"

    echo "‚úÖ Oh My Zsh and plugins installed."
}

_setup_npm_packages() {
    echo "Setting up npm packages..."

    if ! command -v npm &> /dev/null; then
        echo "‚ùå npm not found, please install Node.js first."
        return 1
    fi

    # Define global npm packages to install/update
    local npm_packages=(
        "@anthropic-ai/claude-code"
        "@google/gemini-cli"
        "@github/copilot"
    )
    
    echo "Installing/updating global npm packages..."
    
    npm update -g npm
    
    for package in "${npm_packages[@]}"; do
        echo "Installing/updating $package..."
        npm install -g "$package@latest"
    done
    
    echo "‚úÖ npm packages setup completed!"
}

# ============================================================================
# Main Execution
# ============================================================================

main() {
    local os_name
    os_name=$(detect_os)
    
    echo "Detected OS: $os_name"
    echo ""
    
    # Load environment variables
    load_env "$SCRIPT_DIR"
    
    # Run platform-specific setup
    if is_macos; then
        if [ -f "$SCRIPT_DIR/setup-macos" ]; then
            bash "$SCRIPT_DIR/setup-macos"
        else
            echo "‚ùå setup-macos not found"
            exit 1
        fi
    elif is_ubuntu; then
        if [ -f "$SCRIPT_DIR/setup-ubuntu" ]; then
            bash "$SCRIPT_DIR/setup-ubuntu"
        else
            echo "‚ùå setup-ubuntu not found"
            exit 1
        fi
    else
        echo "‚ùå Unsupported OS: $os_name"
        echo "Supported: macos, ubuntu"
        exit 1
    fi
    
    # Ensure Homebrew is on PATH for macOS (arm64) after platform setup
    if is_macos && [[ $(uname -m) == "arm64" ]] && [[ ":$PATH:" != *":/opt/homebrew/bin:"* ]]; then
        export PATH="/opt/homebrew/bin:$PATH"
    fi
    
    echo ""
    echo "üîß Running cross-platform setup..."
    echo ""
    
    # Run shared setup functions
    _setup_zsh
    _setup_git_identities
    _setup_npm_packages
    
    echo ""
    echo "üéâ All done! Your development environment is ready."
    echo ""
    echo "üìù Next steps:"
    echo "  1. Restart your terminal or run: source ~/.zshrc"
    if is_ubuntu; then
        echo "  2. If you changed default shell to zsh, log out and log back in"
    fi
}

main "$@"
